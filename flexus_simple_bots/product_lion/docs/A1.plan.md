<!-- 97679751-c95c-4fad-86a7-a33ffc7d1b5e 3dfc6ee2-c3ff-41fe-b80b-c62a20d175bc -->
# Productman A1 Integration Plan

## Overview

Implement full A1 activity (Idea Structuring) with First Principles methodology, structured artifacts, validation workflow with sanctions, and versioning.

**Scope**: Must Have + Should Have from analysis

**Approach**:

- LLM-based validation (flexible)
- Breaking change (no backwards compatibility)
- Folder structure: `/customer-research/{idea-name}/canvas` and `/{idea-name}/sheet`

---

## Phase 1: Update Artifact Structures

### 1.1 Create First Principles Canvas Tool

**File**: `flexus_simple_bots/productman/productman_bot.py`

Replace `IDEA_TEMPLATE_TOOL` (lines 23-36) with `FIRST_PRINCIPLES_CANVAS_TOOL`:

```python
FIRST_PRINCIPLES_CANVAS_TOOL = ckit_cloudtool.CloudTool(
    name="create_first_principles_canvas",
    description="Create First Principles Canvas for decomposing raw idea into fundamental truths, constraints, and testable assumptions. Path: /customer-research/{idea-name}/canvas",
    parameters={
        "type": "object",
        "properties": {
            "idea_name": {
                "type": "string",
                "description": "Idea name in kebab-case (e.g. 'slack-microwave')"
            }
        },
        "required": ["idea_name"]
    }
)
```

Update handler `toolcall_idea_template` (lines 73-137) to:

- Accept `idea_name` parameter instead of `path`
- Construct path as `/customer-research/{idea_name}/canvas`
- Use Canvas skeleton structure (8 fields):
  ```python
  canvas = {
      "fundamental_truth": "",
      "atomic_value": "",
      "constraints": [],
      "current_workarounds": "",
      "minimum_end_to_end_scenario": [],
      "critical_assumptions": [],
      "success_metrics": {"metric_name": "", "order_of_magnitude": ""},
      "one_sentence_statement": "",
      "meta": {"created": "", "version": "v0"}
  }
  ```


### 1.2 Create Idea Framing Sheet Tool

**File**: `flexus_simple_bots/productman/productman_bot.py`

Add new tool after Canvas tool:

```python
IDEA_FRAMING_SHEET_TOOL = ckit_cloudtool.CloudTool(
    name="create_idea_framing_sheet",
    description="Create or update Idea Framing Sheet - structured validated summary of an idea. Path: /customer-research/{idea-name}/sheet",
    parameters={
        "type": "object",
        "properties": {
            "idea_name": {
                "type": "string",
                "description": "Idea name in kebab-case"
            },
            "sheet_data": {
                "type": "object",
                "description": "Sheet content (optional, for updates). If empty, creates blank template."
            }
        },
        "required": ["idea_name"]
    }
)
```

Handler creates Sheet structure (10 fields):

```python
sheet = {
    "title": "",
    "one_sentence_pitch": "",
    "target_segment": {
        "who": "",
        "characteristics": [],
        "size_estimate": ""
    },
    "core_problem": {
        "description": "",
        "current_impact": "",
        "frequency": ""
    },
    "value_proposition": {
        "atomic_value": "",
        "differentiation": ""
    },
    "key_assumptions": [],
    "constraints": [],
    "why_now": "",
    "meta": {
        "version": "v0",
        "validation_status": "pending"
    }
}
```

Path: `/customer-research/{idea_name}/sheet`

### 1.3 Update TOOLS list

**File**: `flexus_simple_bots/productman/productman_bot.py` (line 53)

```python
TOOLS = [
    FIRST_PRINCIPLES_CANVAS_TOOL,
    IDEA_FRAMING_SHEET_TOOL,
    HYPOTHESIS_TEMPLATE_TOOL,
    fi_pdoc.POLICY_DOCUMENT_TOOL,
]
```

---

## Phase 2: Add Validation Tool

### 2.1 Create Validate Artifact Tool

**File**: `flexus_simple_bots/productman/productman_bot.py`

Add tool definition:

```python
VALIDATE_ARTIFACT_TOOL = ckit_cloudtool.CloudTool(
    name="validate_artifact",
    description="Validate artifact (Canvas or Sheet) against quality criteria. Returns status (pass/pass-with-warnings/fail) with issues and suggestions.",
    parameters={
        "type": "object",
        "properties": {
            "artifact_path": {
                "type": "string",
                "description": "Path to artifact (e.g. /customer-research/slack-microwave/sheet)"
            },
            "artifact_type": {
                "type": "string",
                "enum": ["canvas", "sheet"],
                "description": "Type of artifact to validate"
            }
        },
        "required": ["artifact_path", "artifact_type"]
    }
)
```

Add to TOOLS list.

### 2.2 Implement LLM-based Validation Handler

**File**: `flexus_simple_bots/productman/productman_bot.py`

Add handler in `productman_main_loop`:

```python
@rcx.on_tool_call(VALIDATE_ARTIFACT_TOOL.name)
async def toolcall_validate_artifact(toolcall: ckit_cloudtool.FCloudtoolCall, model_produced_args: Dict[str, Any]) -> str:
    artifact_path = model_produced_args.get("artifact_path", "")
    artifact_type = model_produced_args.get("artifact_type", "")
    
    # Read artifact
    artifact_content = await pdoc_integration.pdoc_read(artifact_path, toolcall.fcall_ft_id)
    artifact_data = json.loads(artifact_content)
    
    # Get validation criteria from prompts module
    if artifact_type == "sheet":
        criteria = productman_prompts.IDEA_FRAMING_SHEET_VALIDATION_CRITERIA
    else:
        criteria = productman_prompts.FIRST_PRINCIPLES_CANVAS_VALIDATION_CRITERIA
    
    # Call LLM for validation
    validation_prompt = f"""
Validate this {artifact_type} against criteria:

Artifact:
{json.dumps(artifact_data, indent=2)}

Criteria:
{criteria}

Return JSON:
{{
  "status": "pass | pass-with-warnings | fail",
  "issues": [
    {{"severity": "critical|warning|info", "criterion": "...", "description": "...", "location": "..."}}
  ],
  "suggestions": [
    {{"issue_ref": 0, "fix": "..."}}
  ]
}}
"""
    
    validation_result = await ckit_ask_model.ask_model_simple(
        fclient=fclient,
        model_name="gpt-4",
        prompt=validation_prompt
    )
    
    # Parse and format result
    result = json.loads(validation_result)
    
    # Format human-readable response
    status = result["status"]
    issues_text = "\n".join([
        f"  [{i['severity'].upper()}] {i['criterion']}: {i['description']} (at {i['location']})"
        for i in result["issues"]
    ])
    
    response = f"Validation Status: {status.upper()}\n\n"
    if result["issues"]:
        response += f"Issues:\n{issues_text}\n\n"
    if result["suggestions"]:
        suggestions_text = "\n".join([f"  - {s['fix']}" for s in result["suggestions"]])
        response += f"Suggestions:\n{suggestions_text}"
    
    return response
```

---

## Phase 3: Update Prompt with Methodology

### 3.1 Add Validation Criteria Constants

**File**: `flexus_simple_bots/productman/productman_prompts.py`

Add after `example_hypothesis` (before `productman_prompt`):

```python
# Validation criteria from controls/idea-validation-criteria.md
IDEA_FRAMING_SHEET_VALIDATION_CRITERIA = """
CRITICAL CRITERIA (fail if violated):
- C1: Target segment must be specific (not "SMBs" or "developers")
- C2: Atomic value must be measurable with specific change
- C3: Core problem must not include solution/features
- C4: All assumptions must have testability rating
- C5: One-sentence pitch must follow template: "We help [who] achieve [result] within [constraints] by [approach]"

WARNING CRITERIA (pass-with-warnings):
- W1: Market size estimate missing or vague
- W2: Why now field empty
- W3: < 3 key assumptions
- W4: All assumptions marked high criticality
"""

FIRST_PRINCIPLES_CANVAS_VALIDATION_CRITERIA = """
CRITICAL CRITERIA:
- Fundamental truth must be factual (not opinion)
- Atomic value must be measurable
- Each assumption must be falsifiable
- One-sentence statement must be understandable in one read
- No solutions mentioned before problem articulated

WARNING CRITERIA:
- Constraints too generic without specifics
- Success metrics too precise (should be order-of-magnitude)
"""
```

### 3.2 Add First Principles Methodology Section

**File**: `flexus_simple_bots/productman/productman_prompts.py`

Replace `productman_prompt` content (lines 44-87) with expanded version including:

1. **Introduction** (keep existing)
2. **NEW: First Principles Methodology** (~200 lines from controls/first-principles-canvas-rules.md):

                                                - Core Logic (Challenge Assumptions, Decompose, Rebuild)
                                                - Canvas Field Rules
                                                - Anti-Patterns
                                                - Validation Checklist

3. **NEW: A1 Workflow** (~50 lines):
   ```
   ## Your A1 Workflow (Idea Structuring)
   
   Step 1 (A11): Create First Principles Canvas
   - Use create_first_principles_canvas(idea_name="...")
   - Path will be: /customer-research/{idea-name}/canvas
   - Fill fields by challenging user's assumptions
   - Example dialog:
     User: "Founders want faster GTM"
     You: "What evidence shows this? How do they solve it today? What's measurable?"
   
   Step 2 (A11): Synthesize Idea Framing Sheet
   - Use create_idea_framing_sheet(idea_name="...")
   - Read Canvas, extract structured data
   - Map Canvas fields to Sheet:
     * fundamental_truth → core_problem.description
     * atomic_value → value_proposition.atomic_value
     * one_sentence_statement → one_sentence_pitch
     * critical_assumptions → key_assumptions (with criticality/testability)
   
   Step 3 (A12): Validate Sheet
   - Use validate_artifact(artifact_path="/customer-research/{idea-name}/sheet", artifact_type="sheet")
   - Check output status
   
   Step 4 (A13): Handle Validation Result
   - If PASS → Done! Tell user "Sheet validated, ready for A2 (hypothesis generation)"
   - If PASS-WITH-WARNINGS → Request user sanction (see Sanction Workflow below)
   - If FAIL → Fix issues, update Sheet, re-validate (loop to Step 2)
   
   ## Sanction Workflow (for pass-with-warnings)
   
   When validation returns "pass-with-warnings":
   
   1. Present warnings clearly:
      "Your Idea Framing Sheet has 2 warnings:
       - W1: Market size estimate is missing
       - W2: Why now field is empty
       
       These are not blocking, but recommended to address.
       
       Options:
       A) Address warnings now (I'll help you fill missing fields)
       B) Proceed as-is (acknowledge warnings and continue to A2)"
   
   2. Wait for user choice
   
   3. If A: Help fix, re-validate
      If B: Update sheet meta with sanction, set status to "proceed-as-is", continue
   ```

4. **Updated Path Structure**:
   ```
   /customer-research/{idea-name}/canvas         # First Principles Canvas
   /customer-research/{idea-name}/sheet          # Idea Framing Sheet
   /customer-research/{idea-name}/hypotheses/... # Problem/Solution Hypotheses (future A2-A3)
   /customer-research/{idea-name}/surveys/...    # Surveys (future A4-A6)
   ```

5. **Updated Examples** (Canvas + Sheet from artifacts/*.json)

---

## Phase 4: Add Versioning

### 4.1 Implement Version Management

**File**: `flexus_simple_bots/productman/productman_bot.py`

Update Sheet handler to support versioning:

```python
async def toolcall_create_idea_framing_sheet(...):
    base_path = f"/customer-research/{idea_name}/sheet"
    
    # Check for existing versions
    existing_versions = await pdoc_integration.pdoc_list(f"/customer-research/{idea_name}/")
    sheet_files = [f for f in existing_versions if f.startswith("sheet")]
    
    # Determine next version
    if sheet_files:
        # Extract version numbers (sheet-v0, sheet-v1, ...)
        versions = [int(f.split("-v")[1]) for f in sheet_files if "-v" in f]
        next_version = max(versions) + 1 if versions else 1
        path = f"{base_path}-v{next_version}"
        version = f"v{next_version}"
    else:
        path = f"{base_path}-v0"
        version = "v0"
    
    # Update meta.version in sheet_data
    if "meta" not in sheet_data:
        sheet_data["meta"] = {}
    sheet_data["meta"]["version"] = version
    sheet_data["meta"]["created"] = datetime.utcnow().isoformat()
    
    # Write with version path
    await pdoc_integration.pdoc_write(path, json.dumps(sheet_data, indent=2), toolcall.fcall_ft_id)
```

Update prompt to mention versioning:

- "When you update a Sheet after validation feedback, increment version (v0 → v1 → v2)"
- "Always work with latest version, but keep history for audit"

---

## Phase 5: Add Sanction Logging

### 4.2 Implement Sanction Metadata

**File**: `flexus_simple_bots/productman/productman_bot.py`

Add sanction recording when user chooses "proceed as-is":

```python
async def record_sanction(idea_name: str, warnings: List[Dict], user_reasoning: str):
    sheet_path = f"/customer-research/{idea_name}/sheet-v{latest_version}"
    sheet_content = await pdoc_integration.pdoc_read(sheet_path)
    sheet_data = json.loads(sheet_content)
    
    # Add sanction metadata
    sheet_data["meta"]["validation_status"] = "proceed-as-is"
    sheet_data["meta"]["sanction"] = {
        "timestamp": datetime.utcnow().isoformat(),
        "acknowledged_warnings": [w["criterion"] + ": " + w["description"] for w in warnings],
        "user_reasoning": user_reasoning
    }
    
    # Write updated sheet
    await pdoc_integration.pdoc_write(sheet_path, json.dumps(sheet_data, indent=2))
```

Call this in validation handler when user sanctions warnings.

---

## Phase 6: Testing

### Test Case 1: Create First Principles Canvas

**Input**: User says "I have an idea: microwave that sets Slack status"

**Expected**:

- Canvas created at `/customer-research/slack-microwave/canvas`
- Contains 8 fields (fundamental_truth, atomic_value, ...)
- Bot challenges assumptions ("How often is this a problem? What do people do today?")

### Test Case 2: Synthesize Idea Framing Sheet

**Input**: User says "Now create Sheet from Canvas"

**Expected**:

- Sheet created at `/customer-research/slack-microwave/sheet-v0`
- Fields mapped from Canvas (fundamental_truth → core_problem.description, etc.)
- Version set to v0

### Test Case 3: Validation with FAIL

**Input**: User validates Sheet with vague target segment ("developers")

**Expected**:

- Validation returns FAIL with critical issue: "C1: Target segment too broad"
- Suggestion: "Narrow to: 'remote software engineers, 100-500 person companies, using Slack daily'"
- Bot asks user to fix and re-validate

### Test Case 4: Validation with PASS-WITH-WARNINGS

**Input**: User validates Sheet missing "why now" field

**Expected**:

- Validation returns PASS-WITH-WARNINGS with W2
- Bot presents options: A) Address now, B) Proceed as-is
- If B chosen: Sheet meta updated with sanction, status = "proceed-as-is"

### Test Case 5: Versioning on Update

**Input**: User fixes issues and updates Sheet

**Expected**:

- New file created: `/customer-research/slack-microwave/sheet-v1`
- Old v0 remains for history
- meta.version = "v1"

---

## Implementation Order

1. Phase 1.1: Canvas tool (30 min)
2. Phase 1.2: Sheet tool (30 min)
3. Phase 3: Prompt update with methodology (2 hours)
4. Phase 2: Validation tool + handler (2 hours)
5. Phase 4: Versioning (1 hour)
6. Phase 5: Sanction logging (1 hour)
7. Phase 6: Testing all cases (1 hour)

**Total Estimated Time**: 8 hours

---

## Files Modified

- `flexus_simple_bots/productman/productman_bot.py` (tools, handlers, versioning)
- `flexus_simple_bots/productman/productman_prompts.py` (methodology, criteria, examples)
- `flexus_simple_bots/productman/productman_install.py` (update tool descriptions in marketplace)

## Files Created

- `flexus_simple_bots/productman/docs/productman-a1-analysis.md` (already exists, keep for reference)

### To-dos

- [ ] Create First Principles Canvas tool and handler with 8-field structure
- [ ] Create Idea Framing Sheet tool and handler with 10-field structure
- [ ] Update prompt with First Principles methodology, A1 workflow, sanction workflow, and updated examples
- [ ] Create validate_artifact tool with LLM-based validation handler
- [ ] Implement versioning for Sheet artifacts (v0, v1, v2...)
- [ ] Add sanction metadata recording when user chooses proceed-as-is
- [ ] Test all 5 test cases: Canvas creation, Sheet synthesis, validation (fail/warnings), versioning